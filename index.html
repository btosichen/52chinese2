<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2 åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿” - äº’å‹•å­¸ç¿’ç¶² (å¤§å­—ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #E0F7FA 0%, #FCE4EC 50%, #FFF9C4 100%);
            background-attachment: fixed;
            /* åŸºç¤å­—é«”åŠ å¤§ */
            font-size: 1.25rem; 
        }
        
        /* è¶…å¼·è¨˜æ†¶æ³•é…è‰²ç³»çµ± */
        .mem-yellow { background-color: #FFF59D; color: #827717; padding: 4px 8px; border-radius: 6px; border-bottom: 3px solid #FBC02D; }
        .mem-blue { color: #0277BD; font-weight: bold; border-bottom: 3px dashed #4FC3F7; }
        .mem-green { color: #2E7D32; background-color: #E8F5E9; padding: 4px 8px; border-radius: 6px; }
        .mem-red { color: #C62828; font-weight: bold; text-decoration: underline; text-decoration-style: wavy; }

        .card {
            background: rgba(255, 255, 255, 0.95); /* ç¨å¾®å¢åŠ ä¸é€æ˜åº¦ä»¥æå‡å°æ¯” */
            backdrop-filter: blur(10px);
            border-radius: 24px; /* åœ“è§’åŠ å¤§ */
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }

        .btn-custom {
            transition: all 0.2s;
            box-shadow: 0 6px 8px rgba(0,0,0,0.15); /* é™°å½±åŠ æ·± */
        }
        .btn-custom:active { transform: scale(0.95); }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        .correct-anim { animation: bounce 0.5s; background-color: #A5D6A7 !important; border-color: #2E7D32 !important; }
        .wrong-anim { animation: shake 0.5s; background-color: #EF9A9A !important; border-color: #C62828 !important; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        /* æ”¹éŒ¯å­—å°ˆç”¨ - åŠ å¤§é»æ“Šå€ */
        .typo-char { 
            cursor: pointer; 
            padding: 4px 6px; 
            margin: 0 2px;
            border-bottom: 3px solid transparent; 
            transition: all 0.2s; 
            font-size: 1.75rem; /* å­—é«”ç‰¹å¤§ */
            line-height: 2.5rem;
        }
        .typo-char:hover { background-color: #FFEBEE; border-bottom: 3px solid #EF5350; }
        
        /* é…å°é€£é€£çœ‹ */
        .match-selected { background-color: #B3E5FC !important; transform: scale(1.05); border: 4px solid #0288D1 !important; }
        .match-solved { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        
        /* é¸å–®æŒ‰éˆ•å°ˆç”¨ */
        .menu-btn { min-height: 180px; }
    </style>
</head>
<body class="text-gray-800 pb-32 leading-relaxed">

<!-- ç™»å…¥æ¨¡æ…‹æ¡† -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-10 rounded-[2rem] shadow-2xl max-w-lg w-full text-center pop-in relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-6 bg-gradient-to-r from-blue-400 via-pink-400 to-yellow-400"></div>
        <div class="text-7xl mb-6">ğŸ¹</div>
        <h2 class="text-4xl font-bold mb-4 text-indigo-600">æ­¡è¿ä¾†åˆ°<br>éŸ³æ¨‚çš„ç¿…è†€</h2>
        <p class="text-xl text-gray-500 mb-8">è«‹è¼¸å…¥ä½ çš„åå­—ï¼Œå°æ›¸ç²¾æœƒå¹«ä½ è¨˜éŒ„å­¸ç¿’æ­·ç¨‹å–”ï¼</p>
        <input type="text" id="studentName" placeholder="ä¾‹å¦‚ï¼šäº”å¹´ä¸€ç­ ç‹å°æ˜" class="w-full p-6 border-4 border-indigo-100 rounded-2xl mb-6 text-center focus:outline-none focus:border-indigo-400 transition text-2xl">
        <button onclick="startApp()" class="w-full bg-indigo-500 text-white font-bold py-5 rounded-2xl hover:bg-indigo-600 transition shadow-lg text-2xl">é–‹å§‹å†’éšª ğŸš€</button>
    </div>
</div>

<!-- å°èˆªåˆ— -->
<nav class="sticky top-0 z-40 bg-white bg-opacity-95 backdrop-blur shadow-md px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
        <div class="bg-indigo-100 p-3 rounded-full text-indigo-600 text-2xl"><i class="fas fa-music"></i></div>
        <span class="font-bold text-indigo-800 text-xl hidden sm:block">åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”</span>
    </div>
    <div class="flex gap-3 items-center">
        <button onclick="showHistory()" class="bg-yellow-100 text-yellow-800 px-5 py-2 rounded-full text-lg font-bold border-2 border-yellow-300 hover:bg-yellow-200 transition">
            <i class="fas fa-trophy mr-1"></i> æˆ‘çš„è¨˜éŒ„
        </button>
        <span id="displayUser" class="bg-gray-100 px-5 py-2 rounded-full text-lg font-bold text-gray-600 border-2 border-gray-200">æœªç™»å…¥</span>
    </div>
</nav>

<!-- ä¸»å…§å®¹å€ -->
<main class="container mx-auto px-4 mt-8 max-w-5xl" id="mainApp" style="display:none;">

    <!-- å½±éŸ³å°ˆå€ -->
    <section class="mb-10">
        <div class="grid md:grid-cols-2 gap-6">
            <div class="card p-6">
                <h3 class="font-bold text-2xl mb-4 text-indigo-600 flex items-center"><i class="fas fa-video mr-3"></i>èª²æ–‡å¼•å°</h3>
                <video controls class="w-full rounded-xl shadow-lg bg-black">
                    <source src="https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/å¼•å°å‹•ç•«/L02å¼•å°å‹•ç•«_åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”.mp4" type="video/mp4">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
                </video>
            </div>
            <div class="card p-6">
                <h3 class="font-bold text-2xl mb-4 text-pink-600 flex items-center"><i class="fas fa-headphones mr-3"></i>èª²æ–‡æœ—è®€</h3>
                <video controls class="w-full rounded-xl shadow-lg bg-black">
                    <source src="https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/éš¨æ–‡æœ—è®€å‹•ç•«/L02éš¨æ–‡æœ—è®€å‹•ç•«_åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”.mp4" type="video/mp4">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
                </video>
            </div>
        </div>
    </section>

    <!-- åŠŸèƒ½é¸å–® (Dashboard) -->
    <div class="grid grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
        <button onclick="switchTab('keypoints')" class="card menu-btn p-8 flex flex-col items-center justify-center hover:bg-yellow-50 cursor-pointer text-center">
            <div class="text-6xl mb-4">ğŸŒˆ</div>
            <div class="text-2xl font-bold text-gray-700">é‡é»è¦–è¦ºåŒ–</div>
        </button>
        <button onclick="switchTab('vocab')" class="card menu-btn p-8 flex flex-col items-center justify-center hover:bg-blue-50 cursor-pointer text-center">
            <div class="text-6xl mb-4">ğŸ“</div>
            <div class="text-2xl font-bold text-gray-700">å­—è©èˆ‡æˆèª</div>
        </button>
        <button onclick="switchTab('typo')" class="card menu-btn p-8 flex flex-col items-center justify-center hover:bg-red-50 cursor-pointer text-center">
            <div class="text-6xl mb-4">âœï¸</div>
            <div class="text-2xl font-bold text-gray-700">éŒ¯å­—åµæ¢</div>
        </button>
        <button onclick="switchTab('synonym')" class="card menu-btn p-8 flex flex-col items-center justify-center hover:bg-purple-50 cursor-pointer text-center">
            <div class="text-6xl mb-4">ğŸ”„</div>
            <div class="text-2xl font-bold text-gray-700">è©èªå°å°ç¢°</div>
        </button>
        <button onclick="switchTab('comprehension')" class="card menu-btn p-8 flex flex-col items-center justify-center hover:bg-green-50 cursor-pointer text-center">
            <div class="text-6xl mb-4">â­•âŒ</div>
            <div class="text-2xl font-bold text-gray-700">ç†è§£å¤§è€ƒé©—</div>
        </button>
        <button onclick="switchTab('rhetoric')" class="card menu-btn p-8 flex flex-col items-center justify-center hover:bg-pink-50 cursor-pointer text-center">
            <div class="text-6xl mb-4">ğŸ­</div>
            <div class="text-2xl font-bold text-gray-700">ä¿®è¾­é­”æ³•å¸«</div>
        </button>
    </div>

    <!-- é—–é—œéŠæˆ²æŒ‰éˆ• (ç‰¹åˆ¥é¡¯çœ¼) -->
    <button onclick="switchTab('game')" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-3xl p-6 shadow-xl mb-10 transform hover:scale-[1.01] transition flex items-center justify-center text-3xl font-bold border-4 border-white ring-4 ring-blue-200">
        <span class="mr-4 text-5xl">ğŸ®</span> é—–é—œæŒ‘æˆ°ï¼šè²éŸ³é£›ç¿”ä»»å‹™
    </button>

    <!-- å…§å®¹å±•ç¤ºå€ -->
    <div id="contentArea" class="relative min-h-[500px]">
        
        <!-- 1. é‡é»è¦–è¦ºåŒ– -->
        <div id="view-keypoints" class="view-section hidden">
            <div class="card p-8 bg-white">
                <h2 class="text-3xl font-bold mb-8 text-center text-indigo-600 bg-indigo-50 py-3 rounded-xl border border-indigo-100">ğŸŒˆ èª²æ–‡é‡é»è¶…å¼·è¨˜æ†¶</h2>
                <div class="space-y-6">
                    <div class="flex items-start gap-6 p-4 rounded-2xl hover:bg-gray-50 transition border border-transparent hover:border-gray-200">
                        <div class="text-5xl">ğŸ¹</div>
                        <div>
                            <h4 class="font-bold text-2xl mb-2"><span class="mem-yellow">éŸ³æ¨‚ç„¡æ‰€ä¸åœ¨</span></h4>
                            <p class="text-gray-600 text-xl">ä¸åªæ˜¯é‹¼ç´ï¼Œç”Ÿæ´»ä¸­çš„é‹ç¢—ç“¢ç›†è²éŸ³ä¹Ÿèƒ½è®ŠæˆéŸ³æ¨‚ã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-6 p-4 rounded-2xl hover:bg-gray-50 transition border border-transparent hover:border-gray-200">
                        <div class="text-5xl">ğŸ‘‚</div>
                        <div>
                            <h4 class="font-bold text-2xl mb-2"><span class="mem-green">ç”¨è€³æœµçœ‹ä¸–ç•Œ</span></h4>
                            <p class="text-gray-600 text-xl">é»ƒè£•ç¿”é›–ç„¶çœ‹ä¸è¦‹ï¼Œä½†ä»–ç”¨<span class="mem-blue">è†è½</span>ä»£æ›¿çœ¼ç›æ„Ÿå—ç”Ÿæ´»çš„ç¾å¥½ã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-6 p-4 rounded-2xl hover:bg-gray-50 transition border border-transparent hover:border-gray-200">
                        <div class="text-5xl">ğŸšª</div>
                        <div>
                            <h4 class="font-bold text-2xl mb-2"><span class="mem-red">ä¸Šå¤©é—œé–€å¿…é–‹çª—</span></h4>
                            <p class="text-gray-600 text-xl">é€™æ˜¯ä¸€å€‹<span class="mem-red">å¼•ç”¨</span>ä¿®è¾­ã€‚æ„æ€æ˜¯å¤±å»æŸæ¨£æ±è¥¿ï¼Œå¿…å®šæœƒåœ¨åˆ¥çš„åœ°æ–¹ç²å¾—è£œå„Ÿã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-6 p-4 rounded-2xl hover:bg-gray-50 transition border border-transparent hover:border-gray-200">
                        <div class="text-5xl">ğŸµ</div>
                        <div>
                            <h4 class="font-bold text-2xl mb-2"><span class="mem-yellow">è²éŸ³çš„æ„Ÿå‹•</span></h4>
                            <p class="text-gray-600 text-xl">è²éŸ³ä¸åªæ˜¯è½è¦‹çš„ã€ŒéŸ³ã€ï¼Œæ›´æ˜¯å¿ƒè£¡çš„æ„Ÿå—èˆ‡ç„¡é™çš„æƒ³åƒã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. åœ‹å­—èˆ‡æˆèª -->
        <div id="view-vocab" class="view-section hidden">
            <div class="card p-10 bg-white text-center">
                <h2 class="text-3xl font-bold mb-8 text-blue-600">ğŸ“ å­—è©èˆ‡æˆèªæŒ‘æˆ°</h2>
                <div id="vocab-container"></div>
            </div>
        </div>

        <!-- 3. æ”¹éŒ¯å­— -->
        <div id="view-typo" class="view-section hidden">
            <div class="card p-10 bg-white text-center">
                <h2 class="text-3xl font-bold mb-6 text-red-600">âœï¸ éŒ¯å­—å°åµæ¢</h2>
                <p class="mb-8 text-xl text-gray-500">é»æ“Šå¥å­ä¸­éŒ¯èª¤çš„å­—æŠŠå®ƒæ”¹æ­£ï¼</p>
                <div id="typo-container" class="space-y-8"></div>
            </div>
        </div>

        <!-- 4. è©èªé…å° -->
        <div id="view-synonym" class="view-section hidden">
            <div class="card p-10 bg-white text-center">
                <h2 class="text-3xl font-bold mb-6 text-purple-600">ğŸ”„ è©èªå°å°ç¢°</h2>
                <p class="mb-8 text-xl text-gray-500">é»æ“Šä¸€å€‹è©ï¼Œå†é»æ“Šå®ƒçš„åŒç¾©ã€åç¾©è©æˆ–ä¿®è¾­å¤¥ä¼´ï¼</p>
                <div id="match-game" class="grid grid-cols-2 gap-6"></div>
            </div>
        </div>

        <!-- 5. èª²æ–‡ç†è§£ -->
        <div id="view-comprehension" class="view-section hidden">
            <div class="card p-10 bg-white text-center">
                <h2 class="text-3xl font-bold mb-8 text-green-600">â­•âŒ ç†è§£å¤§è€ƒé©—</h2>
                <div id="comp-container"></div>
            </div>
        </div>

        <!-- 6. ä¿®è¾­ -->
        <div id="view-rhetoric" class="view-section hidden">
            <div class="card p-10 bg-white text-center">
                <h2 class="text-3xl font-bold mb-8 text-pink-600">ğŸ­ ä¿®è¾­é­”æ³•å¸«</h2>
                <div id="rhetoric-container"></div>
            </div>
        </div>

        <!-- 7. é—–é—œéŠæˆ² -->
        <div id="view-game" class="view-section hidden">
            <div class="card p-10 bg-white text-center">
                <h2 class="text-3xl font-bold mb-4 text-indigo-600">ğŸ® è²éŸ³é£›ç¿”ä»»å‹™</h2>
                <div class="flex justify-between items-center mb-8 px-4">
                    <span class="text-xl font-bold bg-indigo-100 text-indigo-600 px-5 py-2 rounded-full border-2 border-indigo-200">é—œå¡ <span id="game-level">1</span>/3</span>
                    <span class="text-xl font-bold bg-yellow-100 text-yellow-700 px-5 py-2 rounded-full border-2 border-yellow-300">å¾—åˆ†: <span id="game-score">0</span></span>
                </div>
                <div id="game-stage" class="min-h-[300px] flex items-center justify-center flex-col"></div>
            </div>
        </div>

    </div>

    <!-- å»¶ä¼¸ä»»å‹™ -->
    <div class="mt-10 card p-8 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-100">
        <h3 class="font-bold text-2xl mb-4 text-indigo-800"><i class="fas fa-star text-yellow-400 mr-2 text-2xl"></i>åŠ åˆ†å»¶ä¼¸ä»»å‹™</h3>
        <p class="mb-4 text-xl text-gray-700">å¦‚æœæˆ‘é–‰ä¸Šçœ¼ç›ï¼Œæˆ‘æœƒç”¨è²éŸ³è¨˜ä½ï¼¿ï¼¿ï¼¿ï¼¿ã€‚</p>
        <textarea id="extend-answer" class="w-full p-5 rounded-2xl border-2 border-blue-200 focus:outline-none focus:border-blue-400 text-xl shadow-inner" rows="3" placeholder="å¯«ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
        <button onclick="submitExtension()" class="mt-4 bg-indigo-500 text-white px-8 py-3 rounded-xl text-xl font-bold hover:bg-indigo-600 transition shadow-lg w-full sm:w-auto">æäº¤æƒ³æ³•</button>
    </div>

</main>

<!-- æ­·å²è¨˜éŒ„æ¨¡æ…‹æ¡† -->
<div id="historyModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white p-8 rounded-[2rem] shadow-2xl max-w-xl w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">ğŸ“Š ä½ çš„å­¸ç¿’è¶³è·¡</h3>
            <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-3xl px-2"><i class="fas fa-times"></i></button>
        </div>
        <div id="historyList" class="space-y-4"></div>
    </div>
</div>

<!-- å›é¥‹æç¤º -->
<div id="feedbackToast" class="fixed bottom-16 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-8 py-4 rounded-full shadow-2xl z-50 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none text-xl font-bold border-2 border-white">
    <span id="feedbackIcon" class="mr-3"></span>
    <span id="feedbackText"></span>
</div>

<script>
    // --- è³‡æ–™èˆ‡è¨­å®š ---
    const SCRIPT_URL = '';
    let currentUser = '';
    let currentScore = 0;
    
    // 1. å­—è©èˆ‡æˆèªè³‡æ–™åº« (æ•´åˆåŸVocabèˆ‡æˆèª)
    const vocabData = [
        // åŸæœ‰é¡Œç›®
        { q: "ä»–æ›¾å¤šæ¬¡ç²å¾—é‹¼ç´å¤§è³½(  )è»ã€‚", opts: ["å† ", "è²«"], a: "å† " },
        { q: "æ‚ æšçš„ç´è²(  )ç·©æµå‹•è‘—ã€‚", opts: ["å¾", "é™¤"], a: "å¾" },
        { q: "å¾ç·©çš„æ³¨éŸ³æ˜¯ï¼Ÿ", opts: ["ã„’ã„©ËŠ", "ã„’ã„©Ë‹"], a: "ã„’ã„©ËŠ" },
        { q: "è‰²å½©(  )ç´›ã€‚", opts: ["ç¹½", "æ¿±"], a: "ç¹½" },
        // æ–°å¢æˆèªé¸æ“‡
        { q: "æ—è€å¸«åœ¨åœ‹éš›èˆè‡ºä¸Šè¡¨ç¾äº®çœ¼ï¼Œåœ¨èˆè¹ˆç•Œå æœ‰ï¼¿ï¼¿ï¼¿ï¼¿ã€‚", opts: ["ä¸€å¸­ä¹‹åœ°", "åƒè»è¬é¦¬", "å•é“æ–¼ç›²"], a: "ä¸€å¸­ä¹‹åœ°" },
        { q: "çˆ¸çˆ¸æŠ±èµ·æˆ‘å’Œå¦¹å¦¹ï¼Œå°ä»–ä¾†èªªï¼¿ï¼¿ï¼¿ï¼¿ã€‚", opts: ["æ˜“å¦‚åæŒ", "ä¸ç–¾ä¸å¾", "ç›¸æ˜ æˆè¶£"], a: "æ˜“å¦‚åæŒ" },
        { q: "å°å¾‘å…©æ—ç´…èŠ±ç¶ è‘‰ï¼Œå½¼æ­¤è¥¯æ‰˜ï¼Œçœ‹èµ·ä¾†ï¼¿ï¼¿ï¼¿ï¼¿ã€‚", opts: ["ç›¸æ˜ æˆè¶£", "å‹‡å† ä¸‰è»", "çª®é€”æœ«è·¯"], a: "ç›¸æ˜ æˆè¶£" },
        { q: "çˆ¸çˆ¸å’Œæ—å”å”èªè­˜äºŒåå¤šå¹´ï¼Œæ—©å°±æ˜¯ï¼¿ï¼¿ï¼¿ï¼¿ã€‚", opts: ["è«é€†ä¹‹äº¤", "å•é“æ–¼ç›²", "è½Ÿè½Ÿçƒˆçƒˆ"], a: "è«é€†ä¹‹äº¤" },
        // æ–°å¢æˆèªæ˜¯é (è½‰ç‚ºå•ç­”)
        { q: "ã€Œä¸ç–¾ä¸å¾ã€æ˜¯å½¢å®¹äº‹æƒ…é€²è¡Œå¾—å¤ªå¿«å—ï¼Ÿ", opts: ["å°", "éŒ¯"], a: "éŒ¯" },
        { q: "ã€Œå•é“æ–¼ç›²ã€æ˜¯å½¢å®¹å‘ä¸æ‡‚çš„äººè«‹æ•™å—ï¼Ÿ", opts: ["å°", "éŒ¯"], a: "å°" },
        { q: "ã€Œäº”å½©ç¹½ç´›ã€å¸¸ç”¨ä¾†å½¢å®¹é¡è‰²å¾ˆå¤šã€å¾ˆæ¼‚äº®å—ï¼Ÿ", opts: ["å°", "éŒ¯"], a: "å°" },
        { q: "ã€Œå‰è»Šä¹‹é‘‘ã€æ˜¯æé†’è‡ªå·±ä¸è¦é‡è¹ˆåˆ¥äººçš„éŒ¯èª¤å—ï¼Ÿ", opts: ["å°", "éŒ¯"], a: "å°" }
    ];

    // 2. æ”¹éŒ¯å­—è³‡æ–™åº«
    const typoData = [
        { sent: "ä¸Šå¤©ç‚ºæˆ‘å€‘è§€ä¸Šä¸€é“é–€ï¼Œå¿…æœƒæ›¿æˆ‘å€‘æ‰“é–‹å¦ä¸€æ‰‡çª—ã€‚", wrongIndex: 5, wrongChar: "è§€", correct: "é—œ" },
        { sent: "åª½åª½æ­£åœ¨å»šæˆ¿æ´—åˆ·é‹å®›ç“¢ç›†ã€‚", wrongIndex: 9, wrongChar: "å®›", correct: "ç¢—" },
        { sent: "ä»–çš„å‹¤è²æ·±æ·±è¿·ä½äº†å¤§å®¶ã€‚", wrongIndex: 2, wrongChar: "å‹¤", correct: "ç´" },
        // æ–°å¢æˆèªæ”¹éŒ¯
        { sent: "ä»–èªªè©±ç¸½æ˜¯ä¸ç–¾ä¸ä½™ï¼Œååˆ†å„ªé›…ã€‚", wrongIndex: 6, wrongChar: "ä½™", correct: "å¾" },
        { sent: "è«¸è‘›äº®ç¾½æ‰ç¶¸å·¾çš„å½¢è±¡æ·±å…¥äººå¿ƒã€‚", wrongIndex: 4, wrongChar: "æ‰", correct: "æ‰‡" },
        { sent: "é€™æ”¯éšŠä¼å‹‡è²«ä¸‰è»ï¼Œç„¡äººèƒ½æ•µã€‚", wrongIndex: 4, wrongChar: "è²«", correct: "å† " },
        { sent: "é€™é“æ•¸å­¸é¡Œåˆè®šå¤æ€ªï¼Œå¾ˆé›£ç®—ã€‚", wrongIndex: 6, wrongChar: "è®š", correct: "é‘½" }
    ];

    // 3. é…å°è³‡æ–™åº« (æ•´åˆä¿®è¾­é…å°)
    const matchData = [
        // åŸæœ‰é…å°
        { id: 1, text: "æ‚ æš", type: "syn", pair: 2 }, { id: 2, text: "æ‚…è€³", type: "syn", pair: 1 },
        { id: 3, text: "è¿·ä½", type: "syn", pair: 4 }, { id: 4, text: "å¸å¼•", type: "syn", pair: 3 },
        { id: 5, text: "é»‘æš—", type: "ant", pair: 6 }, { id: 6, text: "æ˜äº®", type: "ant", pair: 5 },
        { id: 7, text: "å¾ç·©", type: "ant", pair: 8 }, { id: 8, text: "æ€¥ä¿ƒ", type: "ant", pair: 7 },
        // æ–°å¢ä¿®è¾­é…å°
        { id: 9, text: "è¡Œé›²æµæ°´", type: "rhet", pair: 10 }, { id: 10, text: "è­¬å–»", type: "rhet", pair: 9 },
        { id: 11, text: "ä¸–ç•Œä¾ç„¶é»‘æš—", type: "rhet", pair: 12 }, { id: 12, text: "æ˜ è¥¯", type: "rhet", pair: 11 }
    ];

    // 4. ç†è§£è³‡æ–™åº«
    const compData = [
        { q: "é»ƒè£•ç¿”åªèƒ½ç”¨é‹¼ç´å‰µä½œéŸ³æ¨‚ã€‚", a: false },
        { q: "ç”Ÿæ´»ä¸­çš„è²éŸ³ä¹Ÿèƒ½æˆç‚ºéŸ³æ¨‚ç´ æã€‚", a: true },
        { q: "é»ƒè£•ç¿”é›–ç„¶çœ‹ä¸è¦‹ï¼Œä½†ä»–ç”¨è€³æœµæ„Ÿå—ä¸–ç•Œã€‚", a: true },
        // æ–°å¢ç¶œåˆé¡Œ
        { q: "ä¸‹åˆ—å“ªä¸€å¥æœ€ç¬¦åˆã€ˆåœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”ã€‰çš„å¯«ä½œç‰¹è‰²ï¼Ÿ", opts: ["ç”¨æ„Ÿè¦ºæå¯«éŸ³æ¨‚ï¼Œå½·å½¿è½è¦‹è²éŸ³", "è©³ç´°èªªæ˜æ¨‚ç†çŸ¥è­˜", "ç›´æ¥åˆ—å‡ºæ¼”å¥æŠ€å·§"], a: "ç”¨æ„Ÿè¦ºæå¯«éŸ³æ¨‚ï¼Œå½·å½¿è½è¦‹è²éŸ³" }
    ];

    // 5. ä¿®è¾­è³‡æ–™åº«
    const rhetoricData = [
        { q: "ã€ŒæŒè²æ‰å¦‚é›·èˆ¬çš„éŸ¿èµ·ã€é‹ç”¨äº†ä»€éº¼ä¿®è¾­ï¼Ÿ", opts: ["è­¬å–»", "æ“¬äºº", "æ’æ¯”"], a: "è­¬å–»" },
        { q: "å¼•ç”¨åè¨€ã€Œä¸Šå¤©ç‚ºæˆ‘å€‘é—œä¸Šä¸€é“é–€...ã€æ˜¯ç‚ºäº†ï¼Ÿ", opts: ["å¢åŠ å­—æ•¸", "æ”¯æŒè§€é»", "ç·´ç¿’å¯«å­—"], a: "æ”¯æŒè§€é»" },
        // æ–°å¢ä¿®è¾­é¡Œ
        { q: "ã€Œåæ ¹æ‰‹æŒ‡åœ¨é»‘ç™½ç´éµä¸Šè¼•è¼•èˆå‹•ã€‚ã€ä¸»è¦ä½¿ç”¨å“ªä¸€ç¨®ä¿®è¾­ï¼Ÿ", opts: ["ç–Šå­—", "æ’æ¯”", "å¼•ç”¨"], a: "ç–Šå­—" }, // ä¾æ“šé¡Œæ„é¸é …èª¿æ•´ï¼Œè‹¥å¼·èª¿ã€Œè¼•è¼•ã€å‰‡ç‚ºç–Šå­—
        { q: "ã€Œæ¨‚è²æ‘¸è‘—é»‘å››è™•æµè½‰ã€‚ã€ä½¿ç”¨çš„ä¿®è¾­æ˜¯ï¼Ÿ", opts: ["è­¬å–»", "æ“¬äºº", "èª‡é£¾"], a: "æ“¬äºº" },
        // æ–°å¢ä¿®è¾­æ˜¯é
        { q: "ã€Œè¼•è¼•èˆå‹•ã€æ·±æ·±è¿·ä½ã€ä½¿ç”¨äº†ç–Šå­—ä¿®è¾­ã€‚", a: true },
        { q: "ã€ŒéŸ³æ¨‚å¼•é ˜ä»–æ¨é–‹çª—ï¼Œé£›å‘å¦ä¸€å€‹ä¸–ç•Œã€‚ã€æŠŠéŸ³æ¨‚ç•¶æˆäººä¾†å¯«(æ“¬äºº)ã€‚", a: true },
        { q: "ã€Œè½Ÿéš†éš†çš„ç«è»Šè²ã€å˜©å•¦å•¦çš„é›¨æ»´è²ã€æ­¡ç¬‘è²ã€å±¬æ–¼æ’æ¯”ã€‚", a: true }
    ];

    const gameData = [
        { 
            type: "select", 
            q: "é—œå¡ 1ï¼šæ‰¾å‡ºèª²æ–‡ä¸­çš„ã€Œè²éŸ³æå¯«ã€", 
            opts: ["ä¸ƒå½©ç¹½ç´›", "è½Ÿéš†éš†", "é»‘æ¼†æ¼†"], 
            a: "è½Ÿéš†éš†",
            hint: "æ‰¾æ‰¾çœ‹å“ªå€‹è©æœ‰è²éŸ³çš„æ„Ÿè¦ºï¼Ÿ"
        },
        { 
            type: "select", 
            q: "é—œå¡ 2ï¼šé»ƒè£•ç¿”åœ¨å¤§è³£å ´å–œæ­¡æ•²æ‰“ä»€éº¼ç•¶æ¨‚å™¨ï¼Ÿ", 
            opts: ["è¥¿ç“œ", "é‹ç¢—ç“¢ç›†", "é›»è¦–æ©Ÿ"], 
            a: "é‹ç¢—ç“¢ç›†",
            hint: "åœ¨å»šå…·å€æœƒçœ‹åˆ°ä»€éº¼ï¼Ÿ"
        },
        { 
            type: "select", 
            q: "é—œå¡ 3ï¼šã€ŒéŸ³æ¨‚ç„¡æ‰€ä¸åœ¨ã€é€™å¥è©±ç”¨äº†ä»€éº¼ä¿®è¾­ä¾†å¼·èª¿ï¼Ÿ", 
            opts: ["è¨­å•", "å¼•ç”¨", "èª‡é£¾"], 
            a: "å¼•ç”¨",
            hint: "é€™æ˜¯å¼•ç”¨èª°èªªéçš„è©±å‘¢ï¼Ÿ"
        }
    ];

    // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---

    function startApp() {
        const name = document.getElementById('studentName').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥åå­—å–”ï¼");
        
        currentUser = name;
        document.getElementById('displayUser').textContent = name;
        document.getElementById('displayUser').className = "bg-indigo-100 px-5 py-2 rounded-full text-lg font-bold text-indigo-600 border-2 border-indigo-200";
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('mainApp').classList.add('pop-in');
        
        // åˆå§‹åŒ–å„å–®å…ƒ
        initVocab();
        initTypo();
        initMatch();
        initComp();
        initRhetoric();
        initGame();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + tabId).classList.remove('hidden');
        document.getElementById('view-' + tabId).classList.add('pop-in');
        
        // æ»¾å‹•åˆ°å…§å®¹å€
        document.getElementById('contentArea').scrollIntoView({behavior: 'smooth', block: 'start'});
    }

    function showFeedback(msg, type) {
        const toast = document.getElementById('feedbackToast');
        const text = document.getElementById('feedbackText');
        const icon = document.getElementById('feedbackIcon');
        
        toast.className = `fixed bottom-16 left-1/2 transform -translate-x-1/2 px-8 py-4 rounded-full shadow-2xl z-50 transition-all duration-300 translate-y-0 opacity-100 ${type === 'success' ? 'bg-green-600' : 'bg-orange-500'} text-white text-xl font-bold border-2 border-white`;
        
        icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-lightbulb"></i>';
        text.innerText = msg;

        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-10');
        }, 2000);
    }

    // --- å„å–®å…ƒå¯¦ä½œ ---

    // 1. å­—è©èˆ‡æˆèª (Vocab & Idioms)
    function initVocab() {
        const container = document.getElementById('vocab-container');
        let currentIdx = 0;
        let correctCount = 0;

        function render() {
            if (currentIdx >= vocabData.length) {
                container.innerHTML = `<div class="text-3xl font-bold text-indigo-600 mb-6">ğŸ‰ å®ŒæˆæŒ‘æˆ°ï¼<br>ç­”å° ${correctCount}/${vocabData.length} é¡Œ</div>
                <button onclick="initVocab()" class="mt-4 bg-gray-200 px-8 py-3 rounded-xl text-xl font-bold hover:bg-gray-300">å†ç©ä¸€æ¬¡</button>`;
                saveRecord('å­—è©èˆ‡æˆèª', correctCount, vocabData.length - correctCount);
                return;
            }
            const q = vocabData[currentIdx];
            
            // å‹•æ…‹èª¿æ•´å­—é«”å¤§å°ï¼Œå¦‚æœé¸é …å­—æ•¸å¤š(å¦‚æˆèª)ï¼Œå­—é«”è®Šå°
            const isLongText = q.opts.some(opt => opt.length > 2);
            const btnClass = isLongText 
                ? "btn-custom bg-white border-4 border-blue-200 text-2xl w-48 h-32 rounded-3xl hover:bg-blue-50 font-bold text-blue-700 mx-2"
                : "btn-custom bg-white border-4 border-blue-200 text-5xl w-32 h-32 rounded-3xl hover:bg-blue-50 font-bold text-blue-700";

            container.innerHTML = `
                <div class="text-3xl mb-10 font-bold bg-blue-50 p-8 rounded-2xl inline-block border-4 border-blue-100 leading-relaxed">${q.q}</div>
                <div class="flex flex-wrap justify-center gap-6">
                    ${q.opts.map(opt => `<button onclick="checkVocab('${opt}', '${q.a}')" class="${btnClass}">${opt}</button>`).join('')}
                </div>
            `;
        }

        window.checkVocab = (ans, correct) => {
            if (ans === correct) {
                showFeedback("ç­”å°äº†ï¼", "success");
                correctCount++;
            } else {
                showFeedback("å†æƒ³ä¸€æƒ³å–”ï¼", "hint");
            }
            currentIdx++;
            setTimeout(render, 800);
        };
        render();
    }

    // 2. æ”¹éŒ¯å­—
    function initTypo() {
        const container = document.getElementById('typo-container');
        container.innerHTML = '';
        let correctCount = 0;
        let attempts = 0;

        typoData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = "bg-gray-50 p-6 rounded-2xl border-2 border-gray-200 tracking-wider";
            
            // æ§‹å»ºå¥å­ï¼Œæ¯å€‹å­—éƒ½æ˜¯å¯é»æ“Šçš„
            let html = '';
            for(let i=0; i<item.sent.length; i++) {
                html += `<span class="typo-char" onclick="checkTypo(this, ${idx}, ${i})">${item.sent[i]}</span>`;
            }
            div.innerHTML = html;
            div.id = `typo-row-${idx}`;
            container.appendChild(div);
        });

        window.checkTypo = (span, itemIdx, charIdx) => {
            const q = typoData[itemIdx];
            if (charIdx === q.wrongIndex) {
                span.innerText = q.correct;
                span.className = "text-red-600 font-bold border-b-4 border-red-500 pb-1 mx-1 px-2 bg-red-50 rounded text-3xl";
                span.onclick = null; // ç§»é™¤é»æ“Šäº‹ä»¶
                showFeedback("å¤ªæ£’äº†ï¼å°åµæ¢æ‰¾åˆ°éŒ¯å­—äº†ï¼", "success");
                
                // é¡¯ç¤ºè§£é‡‹
                const explain = document.createElement('div');
                explain.className = "mt-4 text-lg text-gray-600 bg-white p-3 rounded-xl shadow-sm inline-block border border-gray-100";
                explain.innerHTML = `<i class="fas fa-info-circle text-blue-400 mr-2"></i> åŸå­—ã€Œ${q.wrongChar}ã€æ˜¯éŒ¯èª¤çš„ï¼Œæ‡‰æ”¹ç‚ºã€Œ${q.correct}ã€ã€‚`;
                document.getElementById(`typo-row-${itemIdx}`).appendChild(explain);

                correctCount++;
                if(correctCount === typoData.length) saveRecord('éŒ¯å­—åµæ¢', correctCount, attempts);
            } else {
                span.classList.add('wrong-anim');
                setTimeout(() => span.classList.remove('wrong-anim'), 500);
                showFeedback("é€™è£¡æ²’æœ‰éŒ¯å­—å–”ï¼Œå†æ‰¾æ‰¾çœ‹ï¼", "hint");
                attempts++;
            }
        };
    }

    // 3. è©èªé…å° (Click to Match)
    function initMatch() {
        const container = document.getElementById('match-game');
        // æ´—ç‰Œ
        const shuffled = [...matchData].sort(() => Math.random() - 0.5);
        container.innerHTML = '';
        let selected = null;
        let matches = 0;
        let errors = 0;

        shuffled.forEach(item => {
            const btn = document.createElement('button');
            // å‹•æ…‹å­—é«”ï¼šå¦‚æœå­—æ•¸å¤š(å¦‚æˆèªã€ä¿®è¾­å¥)ï¼Œå­—é«”ç¨å¾®ç¸®å°
            const fontSize = item.text.length > 4 ? "text-xl" : "text-2xl";
            
            btn.className = `btn-custom bg-white border-2 border-purple-200 text-gray-700 p-4 rounded-2xl font-bold ${fontSize} hover:bg-purple-50 min-h-[100px] flex items-center justify-center`;
            btn.innerText = item.text;
            btn.dataset.id = item.id;
            btn.dataset.pair = item.pair;
            
            btn.onclick = () => {
                if (selected === btn) { // å–æ¶ˆé¸å–
                    btn.classList.remove('match-selected');
                    selected = null;
                    return;
                }

                if (!selected) {
                    selected = btn;
                    btn.classList.add('match-selected');
                } else {
                    // æª¢æŸ¥é…å°
                    if (selected.dataset.pair == btn.dataset.id) {
                        // é…å°æˆåŠŸ
                        selected.classList.add('correct-anim', 'bg-green-200', 'border-green-500');
                        btn.classList.add('correct-anim', 'bg-green-200', 'border-green-500');
                        showFeedback("é…å°æˆåŠŸï¼", "success");
                        
                        const s = selected;
                        const b = btn;
                        setTimeout(() => {
                            s.classList.add('match-solved');
                            b.classList.add('match-solved');
                        }, 500);
                        
                        matches++;
                        selected = null;
                        if(matches === matchData.length / 2) {
                            saveRecord('è©èªé…å°', matches, errors);
                            setTimeout(() => {
                                container.innerHTML = `<div class="col-span-2 text-center text-3xl font-bold text-purple-600 p-8">ğŸ‰ å…¨éƒ¨é…å°å®Œæˆï¼</div>`;
                            }, 1000);
                        }
                    } else {
                        // é…å°å¤±æ•—
                        btn.classList.add('wrong-anim');
                        selected.classList.add('wrong-anim');
                        showFeedback("é€™å…©å€‹ä¸æ˜¯ä¸€å°å–”ï¼", "hint");
                        errors++;
                        setTimeout(() => {
                            btn.classList.remove('wrong-anim');
                            selected.classList.remove('wrong-anim', 'match-selected');
                            selected = null;
                        }, 800);
                    }
                }
            };
            container.appendChild(btn);
        });
    }

    // 4. ç†è§£ & 5. ä¿®è¾­ (Generic Render)
    function renderQuiz(containerId, data, title, typeName) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        let correct = 0;
        let done = 0;

        data.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = "mb-6 bg-gray-50 p-6 rounded-2xl text-left border-2 border-gray-200";
            let optsHtml = '';
            
            if (q.a === true || q.a === false) { // True/False
                optsHtml = `
                    <div class="mt-4 flex gap-4">
                        <button class="btn-custom bg-green-100 text-green-700 w-20 h-20 text-3xl rounded-full hover:bg-green-200 border-2 border-green-300" onclick="checkGen(this, ${q.a}, true, ${idx})">â—‹</button>
                        <button class="btn-custom bg-red-100 text-red-700 w-20 h-20 text-3xl rounded-full hover:bg-red-200 border-2 border-red-300" onclick="checkGen(this, ${q.a}, false, ${idx})">âœ•</button>
                    </div>
                `;
            } else { // Multiple Choice
                optsHtml = `<div class="mt-4 flex flex-wrap gap-3">` + q.opts.map(opt => 
                    `<button class="btn-custom bg-white border-2 border-gray-300 px-6 py-3 rounded-xl hover:bg-gray-100 text-xl font-bold" onclick="checkGen(this, '${q.a}', '${opt}', ${idx})">${opt}</button>`
                ).join('') + `</div>`;
            }

            div.innerHTML = `<p class="font-bold mb-2 text-2xl text-gray-800 leading-snug">${idx+1}. ${q.q}</p><div id="ans-area-${containerId}-${idx}">${optsHtml}</div>`;
            container.appendChild(div);
        });

        // Closure to keep scope
        window[`done_${containerId}`] = 0;
        window[`correct_${containerId}`] = 0;
        
        // Dynamic check function
        window.checkGen = (btn, correctVal, userVal, idx) => {
            const area = btn.parentElement.nodeName === 'DIV' ? btn.parentElement : btn.parentElement; // handle structure diff
            // Disable all buttons in this question
            let btns;
            if(area.id.startsWith('ans-area')) {
                 btns = area.querySelectorAll('button');
            } else {
                 btns = area.parentElement.querySelectorAll('button');
            }
            
            btns.forEach(b => b.disabled = true);

            if (userVal === correctVal) {
                btn.className = "bg-green-500 text-white px-6 py-3 rounded-xl font-bold shadow-md text-xl";
                btn.innerHTML += ' âœ”ï¸';
                showFeedback("ç­”å°äº†ï¼", "success");
                window[`correct_${containerId}`]++;
            } else {
                btn.className = "bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-md text-xl";
                showFeedback("å¯æƒœç­”éŒ¯äº†", "hint");
            }
            window[`done_${containerId}`]++;
            
            if (window[`done_${containerId}`] === data.length) {
                saveRecord(typeName, window[`correct_${containerId}`], data.length - window[`correct_${containerId}`]);
            }
        };
    }

    function initComp() { renderQuiz('comp-container', compData, 'èª²æ–‡ç†è§£', 'èª²æ–‡ç†è§£'); }
    function initRhetoric() { renderQuiz('rhetoric-container', rhetoricData, 'ä¿®è¾­', 'ä¿®è¾­äº’å‹•'); }

    // 6. éŠæˆ²
    function initGame() {
        const stage = document.getElementById('game-stage');
        let level = 0;
        let score = 0;

        function renderLevel() {
            if (level >= gameData.length) {
                stage.innerHTML = `
                    <div class="text-8xl mb-6">ğŸ†</div>
                    <h3 class="text-4xl font-bold text-indigo-700 mb-4">ä»»å‹™å®Œæˆï¼</h3>
                    <p class="text-2xl text-gray-500">ä½ å·²ç¶“æˆç‚ºè²éŸ³é­”æ³•å¸«äº†ï¼</p>
                    <div class="mt-8 font-bold text-3xl text-yellow-600 bg-yellow-50 px-8 py-4 rounded-2xl">æœ€çµ‚å¾—åˆ†: ${score}</div>
                `;
                saveRecord('é—–é—œéŠæˆ²', score/10, gameData.length - (score/10));
                return;
            }

            const q = gameData[level];
            document.getElementById('game-level').innerText = level + 1;
            
            stage.innerHTML = `
                <div class="bg-indigo-50 p-8 rounded-[2rem] w-full max-w-2xl pop-in border-4 border-white shadow-lg">
                    <p class="text-2xl font-bold mb-8 text-indigo-900 leading-relaxed">${q.q}</p>
                    <div class="grid gap-4">
                        ${q.opts.map(opt => `
                            <button onclick="checkGameAns('${opt}', '${q.a}')" class="btn-custom w-full bg-white border-2 border-indigo-100 py-4 rounded-xl font-bold text-indigo-600 text-2xl hover:bg-indigo-500 hover:text-white transition">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.checkGameAns = (ans, correct) => {
            if (ans === correct) {
                score += 10;
                document.getElementById('game-score').innerText = score;
                showFeedback("ç­”å°äº†ï¼æ™‰ç´šä¸‹ä¸€é—œï¼", "success");
                level++;
                setTimeout(renderLevel, 1000);
            } else {
                showFeedback(gameData[level].hint, "hint");
            }
        };
        renderLevel();
    }

    // --- å»¶ä¼¸ä»»å‹™ ---
    function submitExtension() {
        const val = document.getElementById('extend-answer').value;
        if(val) {
            saveRecord('å»¶ä¼¸ä»»å‹™', 1, 0); // åªè¦æäº¤å°±ç®—å®Œæˆ
            alert("æƒ³æ³•å·²æäº¤ï¼è¬è¬ä½ çš„åˆ†äº« â¤ï¸");
            document.getElementById('extend-answer').value = '';
        }
    }

    // --- è³‡æ–™å„²å­˜èˆ‡è¨˜éŒ„ ---
    
    function saveRecord(moduleName, correct, wrong) {
        const record = {
            time: new Date().toLocaleString(),
            name: currentUser,
            module: moduleName,
            correct: correct,
            wrong: wrong,
            score: Math.round((correct / (correct + wrong)) * 100) || 100
        };

        // 1. å­˜å…¥ LocalStorage (å­¸ç”Ÿç«¯è¨˜éŒ„)
        let history = JSON.parse(localStorage.getItem('musicFlyHistory') || '[]');
        history.unshift(record);
        localStorage.setItem('musicFlyHistory', JSON.stringify(history));

        // 2. å‚³é€è‡³ Google Sheet
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // é‡è¦ï¼šé¿å… CORS éŒ¯èª¤
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record)
        }).then(() => {
            console.log("Sent to Google Sheet");
        }).catch(err => console.error(err));
    }

    function showHistory() {
        if (!currentUser) return alert("è«‹å…ˆç™»å…¥å–”ï¼");
        
        const history = JSON.parse(localStorage.getItem('musicFlyHistory') || '[]');
        const list = document.getElementById('historyList');
        const modal = document.getElementById('historyModal');
        
        list.innerHTML = '';
        if (history.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-500 text-xl py-8">ç›®å‰é‚„æ²’æœ‰è¨˜éŒ„ï¼Œå¿«å»æŒ‘æˆ°å§ï¼</p>';
        } else {
            // éæ¿¾ç•¶å‰ä½¿ç”¨è€…çš„è¨˜éŒ„
            const myHistory = history.filter(r => r.name === currentUser);
            myHistory.forEach(r => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-4 rounded-xl border-l-8 border-indigo-400 flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800 text-xl">${r.module}</div>
                        <div class="text-base text-gray-500">${r.time}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold ${r.score >= 80 ? 'text-green-600' : 'text-orange-500'}">${r.score}åˆ†</div>
                        <div class="text-sm text-gray-500">å°${r.correct} / éŒ¯${r.wrong}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        modal.classList.remove('hidden');
    }
</script>
</body>
</html>
