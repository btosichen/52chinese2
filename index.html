<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2 åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿” - äº’å‹•å­¸ç¿’ç¶²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #E0F7FA 0%, #FCE4EC 50%, #FFF9C4 100%); /* å¤©ç©ºè— x éŸ³ç¬¦ç²‰ x æ·¡é»ƒ */
            background-attachment: fixed;
        }
        
        /* è¶…å¼·è¨˜æ†¶æ³•é…è‰²ç³»çµ± */
        .mem-yellow { background-color: #FFF59D; color: #827717; padding: 2px 5px; border-radius: 4px; border-bottom: 2px solid #FBC02D; }
        .mem-blue { color: #0277BD; font-weight: bold; border-bottom: 2px dashed #4FC3F7; }
        .mem-green { color: #2E7D32; background-color: #E8F5E9; padding: 2px 5px; border-radius: 4px; }
        .mem-red { color: #C62828; font-weight: bold; text-decoration: underline; text-decoration-style: wavy; }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }

        .btn-custom {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-custom:active { transform: scale(0.95); }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        .correct-anim { animation: bounce 0.5s; background-color: #A5D6A7 !important; border-color: #2E7D32 !important; }
        .wrong-anim { animation: shake 0.5s; background-color: #EF9A9A !important; border-color: #C62828 !important; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* æ”¹éŒ¯å­—å°ˆç”¨ */
        .typo-char { cursor: pointer; padding: 2px; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .typo-char:hover { background-color: #FFEBEE; border-bottom: 2px solid #EF5350; }
        
        /* é…å°é€£é€£çœ‹ */
        .match-selected { background-color: #B3E5FC !important; transform: scale(1.05); border: 2px solid #0288D1 !important; }
        .match-solved { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
    </style>
</head>
<body class="text-gray-700 pb-20">

<!-- ç™»å…¥æ¨¡æ…‹æ¡† -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center pop-in relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-blue-400 via-pink-400 to-yellow-400"></div>
        <div class="text-6xl mb-4">ğŸ¹</div>
        <h2 class="text-2xl font-bold mb-2 text-indigo-600">æ­¡è¿ä¾†åˆ°éŸ³æ¨‚çš„ç¿…è†€</h2>
        <p class="text-gray-500 mb-6">è«‹è¼¸å…¥ä½ çš„åå­—ï¼Œå°æ›¸ç²¾æœƒå¹«ä½ è¨˜éŒ„å­¸ç¿’æ­·ç¨‹å–”ï¼</p>
        <input type="text" id="studentName" placeholder="ä¾‹å¦‚ï¼šäº”å¹´ä¸€ç­ ç‹å°æ˜" class="w-full p-4 border-2 border-indigo-100 rounded-xl mb-4 text-center focus:outline-none focus:border-indigo-400 transition text-lg">
        <button onclick="startApp()" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl hover:bg-indigo-600 transition shadow-lg">é–‹å§‹å†’éšª ğŸš€</button>
    </div>
</div>

<!-- å°èˆªåˆ— -->
<nav class="sticky top-0 z-40 bg-white bg-opacity-90 backdrop-blur shadow-sm px-4 py-3 flex justify-between items-center">
    <div class="flex items-center gap-2">
        <div class="bg-indigo-100 p-2 rounded-full text-indigo-600"><i class="fas fa-music"></i></div>
        <span class="font-bold text-indigo-800 hidden sm:block">åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”</span>
    </div>
    <div class="flex gap-2">
        <button onclick="showHistory()" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-bold border border-yellow-300 hover:bg-yellow-200 transition">
            <i class="fas fa-trophy mr-1"></i> æˆ‘çš„è¨˜éŒ„
        </button>
        <span id="displayUser" class="bg-gray-100 px-3 py-1 rounded-full text-sm font-bold text-gray-600 border border-gray-200">æœªç™»å…¥</span>
    </div>
</nav>

<!-- ä¸»å…§å®¹å€ -->
<main class="container mx-auto px-4 mt-6 max-w-4xl" id="mainApp" style="display:none;">

    <!-- å½±éŸ³å°ˆå€ -->
    <section class="mb-8">
        <div class="grid md:grid-cols-2 gap-4">
            <div class="card p-4">
                <h3 class="font-bold text-lg mb-2 text-indigo-600"><i class="fas fa-video mr-2"></i>èª²æ–‡å¼•å°</h3>
                <video controls class="w-full rounded-lg shadow-inner bg-black">
                    <source src="https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/å¼•å°å‹•ç•«/L02å¼•å°å‹•ç•«_åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”.mp4" type="video/mp4">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
                </video>
            </div>
            <div class="card p-4">
                <h3 class="font-bold text-lg mb-2 text-pink-600"><i class="fas fa-headphones mr-2"></i>èª²æ–‡æœ—è®€</h3>
                <video controls class="w-full rounded-lg shadow-inner bg-black">
                    <source src="https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/éš¨æ–‡æœ—è®€å‹•ç•«/L02éš¨æ–‡æœ—è®€å‹•ç•«_åœ¨é»‘æš—ä¸­ä¹˜è‘—éŸ³æ¨‚é£›ç¿”.mp4" type="video/mp4">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
                </video>
            </div>
        </div>
    </section>

    <!-- åŠŸèƒ½é¸å–® (Dashboard) -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
        <button onclick="switchTab('keypoints')" class="card p-6 flex flex-col items-center justify-center hover:bg-yellow-50 cursor-pointer text-center h-32">
            <div class="text-4xl mb-2">ğŸŒˆ</div>
            <div class="font-bold text-gray-700">é‡é»è¦–è¦ºåŒ–</div>
        </button>
        <button onclick="switchTab('vocab')" class="card p-6 flex flex-col items-center justify-center hover:bg-blue-50 cursor-pointer text-center h-32">
            <div class="text-4xl mb-2">ğŸ“</div>
            <div class="font-bold text-gray-700">åœ‹å­—æ³¨éŸ³</div>
        </button>
        <button onclick="switchTab('typo')" class="card p-6 flex flex-col items-center justify-center hover:bg-red-50 cursor-pointer text-center h-32">
            <div class="text-4xl mb-2">âœï¸</div>
            <div class="font-bold text-gray-700">éŒ¯å­—åµæ¢</div>
        </button>
        <button onclick="switchTab('synonym')" class="card p-6 flex flex-col items-center justify-center hover:bg-purple-50 cursor-pointer text-center h-32">
            <div class="text-4xl mb-2">ğŸ”„</div>
            <div class="font-bold text-gray-700">è©èªé…å°</div>
        </button>
        <button onclick="switchTab('comprehension')" class="card p-6 flex flex-col items-center justify-center hover:bg-green-50 cursor-pointer text-center h-32">
            <div class="text-4xl mb-2">â­•âŒ</div>
            <div class="font-bold text-gray-700">èª²æ–‡ç†è§£</div>
        </button>
        <button onclick="switchTab('rhetoric')" class="card p-6 flex flex-col items-center justify-center hover:bg-pink-50 cursor-pointer text-center h-32">
            <div class="text-4xl mb-2">ğŸ­</div>
            <div class="font-bold text-gray-700">ä¿®è¾­äº’å‹•</div>
        </button>
    </div>

    <!-- é—–é—œéŠæˆ²æŒ‰éˆ• (ç‰¹åˆ¥é¡¯çœ¼) -->
    <button onclick="switchTab('game')" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-2xl p-4 shadow-lg mb-8 transform hover:scale-[1.02] transition flex items-center justify-center text-xl font-bold">
        <span class="mr-2 text-3xl">ğŸ®</span> é—–é—œæŒ‘æˆ°ï¼šè²éŸ³é£›ç¿”ä»»å‹™
    </button>

    <!-- å…§å®¹å±•ç¤ºå€ -->
    <div id="contentArea" class="relative min-h-[400px]">
        
        <!-- 1. é‡é»è¦–è¦ºåŒ– -->
        <div id="view-keypoints" class="view-section hidden">
            <div class="card p-6 bg-white">
                <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">ğŸŒˆ èª²æ–‡é‡é»è¶…å¼·è¨˜æ†¶</h2>
                <div class="space-y-4">
                    <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-gray-50 transition">
                        <div class="text-3xl">ğŸ¹</div>
                        <div>
                            <h4 class="font-bold text-lg"><span class="mem-yellow">éŸ³æ¨‚ç„¡æ‰€ä¸åœ¨</span></h4>
                            <p class="text-gray-600 mt-1">ä¸åªæ˜¯é‹¼ç´ï¼Œç”Ÿæ´»ä¸­çš„é‹ç¢—ç“¢ç›†è²éŸ³ä¹Ÿèƒ½è®ŠæˆéŸ³æ¨‚ã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-gray-50 transition">
                        <div class="text-3xl">ğŸ‘‚</div>
                        <div>
                            <h4 class="font-bold text-lg"><span class="mem-green">ç”¨è€³æœµçœ‹ä¸–ç•Œ</span></h4>
                            <p class="text-gray-600 mt-1">é»ƒè£•ç¿”é›–ç„¶çœ‹ä¸è¦‹ï¼Œä½†ä»–ç”¨<span class="mem-blue">è†è½</span>ä»£æ›¿çœ¼ç›æ„Ÿå—ç”Ÿæ´»çš„ç¾å¥½ã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-gray-50 transition">
                        <div class="text-3xl">ğŸšª</div>
                        <div>
                            <h4 class="font-bold text-lg"><span class="mem-red">ä¸Šå¤©é—œé–€å¿…é–‹çª—</span></h4>
                            <p class="text-gray-600 mt-1">é€™æ˜¯ä¸€å€‹<span class="mem-red">å¼•ç”¨</span>ä¿®è¾­ã€‚æ„æ€æ˜¯å¤±å»æŸæ¨£æ±è¥¿ï¼Œå¿…å®šæœƒåœ¨åˆ¥çš„åœ°æ–¹ç²å¾—è£œå„Ÿã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-gray-50 transition">
                        <div class="text-3xl">ğŸµ</div>
                        <div>
                            <h4 class="font-bold text-lg"><span class="mem-yellow">è²éŸ³çš„æ„Ÿå‹•</span></h4>
                            <p class="text-gray-600 mt-1">è²éŸ³ä¸åªæ˜¯è½è¦‹çš„ã€ŒéŸ³ã€ï¼Œæ›´æ˜¯å¿ƒè£¡çš„æ„Ÿå—èˆ‡ç„¡é™çš„æƒ³åƒã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. åœ‹å­—æ³¨éŸ³ -->
        <div id="view-vocab" class="view-section hidden">
            <div class="card p-6 bg-white text-center">
                <h2 class="text-2xl font-bold mb-6 text-blue-600">ğŸ“ åœ‹å­—æ³¨éŸ³æŒ‘æˆ°</h2>
                <div id="vocab-container"></div>
            </div>
        </div>

        <!-- 3. æ”¹éŒ¯å­— -->
        <div id="view-typo" class="view-section hidden">
            <div class="card p-6 bg-white text-center">
                <h2 class="text-2xl font-bold mb-4 text-red-600">âœï¸ éŒ¯å­—å°åµæ¢</h2>
                <p class="mb-6 text-gray-500">é»æ“Šå¥å­ä¸­éŒ¯èª¤çš„å­—æŠŠå®ƒæ”¹æ­£ï¼</p>
                <div id="typo-container" class="space-y-6"></div>
            </div>
        </div>

        <!-- 4. è©èªé…å° -->
        <div id="view-synonym" class="view-section hidden">
            <div class="card p-6 bg-white text-center">
                <h2 class="text-2xl font-bold mb-4 text-purple-600">ğŸ”„ è©èªå°å°ç¢°</h2>
                <p class="mb-6 text-gray-500">é»æ“Šä¸€å€‹è©ï¼Œå†é»æ“Šå®ƒçš„åŒç¾©æˆ–åç¾©è©ï¼</p>
                <div id="match-game" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
        </div>

        <!-- 5. èª²æ–‡ç†è§£ -->
        <div id="view-comprehension" class="view-section hidden">
            <div class="card p-6 bg-white text-center">
                <h2 class="text-2xl font-bold mb-6 text-green-600">â­•âŒ ç†è§£å¤§è€ƒé©—</h2>
                <div id="comp-container"></div>
            </div>
        </div>

        <!-- 6. ä¿®è¾­ -->
        <div id="view-rhetoric" class="view-section hidden">
            <div class="card p-6 bg-white text-center">
                <h2 class="text-2xl font-bold mb-6 text-pink-600">ğŸ­ ä¿®è¾­é­”æ³•å¸«</h2>
                <div id="rhetoric-container"></div>
            </div>
        </div>

        <!-- 7. é—–é—œéŠæˆ² -->
        <div id="view-game" class="view-section hidden">
            <div class="card p-6 bg-white text-center">
                <h2 class="text-2xl font-bold mb-2 text-indigo-600">ğŸ® è²éŸ³é£›ç¿”ä»»å‹™</h2>
                <div class="flex justify-between items-center mb-6 px-4">
                    <span class="text-sm font-bold bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full">é—œå¡ <span id="game-level">1</span>/3</span>
                    <span class="text-sm font-bold bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full">å¾—åˆ†: <span id="game-score">0</span></span>
                </div>
                <div id="game-stage" class="min-h-[200px] flex items-center justify-center flex-col"></div>
            </div>
        </div>

    </div>

    <!-- å»¶ä¼¸ä»»å‹™ -->
    <div class="mt-8 card p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-100">
        <h3 class="font-bold text-lg mb-2 text-indigo-800"><i class="fas fa-star text-yellow-400 mr-2"></i>åŠ åˆ†å»¶ä¼¸ä»»å‹™</h3>
        <p class="mb-4 text-gray-700">å¦‚æœæˆ‘é–‰ä¸Šçœ¼ç›ï¼Œæˆ‘æœƒç”¨è²éŸ³è¨˜ä½ï¼¿ï¼¿ï¼¿ï¼¿ã€‚</p>
        <textarea id="extend-answer" class="w-full p-3 rounded-xl border border-blue-200 focus:outline-none focus:border-blue-400" rows="2" placeholder="å¯«ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
        <button onclick="submitExtension()" class="mt-2 bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 transition">æäº¤æƒ³æ³•</button>
    </div>

</main>

<!-- æ­·å²è¨˜éŒ„æ¨¡æ…‹æ¡† -->
<div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full m-4 max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ğŸ“Š ä½ çš„å­¸ç¿’è¶³è·¡</h3>
            <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div id="historyList" class="space-y-3"></div>
    </div>
</div>

<!-- å›é¥‹æç¤º -->
<div id="feedbackToast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none">
    <span id="feedbackIcon" class="mr-2"></span>
    <span id="feedbackText"></span>
</div>

<script>
    // --- è³‡æ–™èˆ‡è¨­å®š ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_F94zepYjcV61hjVBmFWQZ6Ykh5Y2uMUbyuAdUOZtpL2fMTa4_GOCpu_iDCddhX35/exec';
    let currentUser = '';
    let currentScore = 0;
    
    // é¡Œç›®è³‡æ–™åº«
    const vocabData = [
        { q: "ä»–æ›¾å¤šæ¬¡ç²å¾—é‹¼ç´å¤§è³½(  )è»ã€‚", opts: ["å† ", "è²«"], a: "å† " },
        { q: "æ‚ æšçš„ç´è²(  )ç·©æµå‹•è‘—ã€‚", opts: ["å¾", "é™¤"], a: "å¾" },
        { q: "å¾ç·©çš„æ³¨éŸ³æ˜¯ï¼Ÿ", opts: ["ã„’ã„©ËŠ", "ã„’ã„©Ë‹"], a: "ã„’ã„©ËŠ" },
        { q: "è‰²å½©(  )ç´›ã€‚", opts: ["ç¹½", "æ¿±"], a: "ç¹½" }
    ];

    const typoData = [
        { sent: "ä¸Šå¤©é—œäº†ä¸€é“é–€ï¼Œå¿…æœƒæ›¿æˆ‘å€‘æ‰“é–‹å¦ä¸€æ‰‡çª—ã€‚", wrongIndex: 2, wrongChar: "äº†", correct: "ä¸Š" }, // é™·é˜±ï¼šåŸæ–‡æ˜¯"é—œä¸Šä¸€é“é–€"
        { sent: "åª½åª½æ­£åœ¨å»šæˆ¿æ´—åˆ·é‹å®›ç“¢ç›†ã€‚", wrongIndex: 9, wrongChar: "å®›", correct: "ç¢—" },
        { sent: "ä»–çš„å‹¤è²æ·±æ·±è¿·ä½äº†å¤§å®¶ã€‚", wrongIndex: 2, wrongChar: "å‹¤", correct: "ç´" }
    ];

    const matchData = [
        { id: 1, text: "æ‚ æš", type: "syn", pair: 2 }, { id: 2, text: "æ‚…è€³", type: "syn", pair: 1 },
        { id: 3, text: "è¿·ä½", type: "syn", pair: 4 }, { id: 4, text: "å¸å¼•", type: "syn", pair: 3 },
        { id: 5, text: "é»‘æš—", type: "ant", pair: 6 }, { id: 6, text: "æ˜äº®", type: "ant", pair: 5 },
        { id: 7, text: "å¾ç·©", type: "ant", pair: 8 }, { id: 8, text: "æ€¥ä¿ƒ", type: "ant", pair: 7 }
    ];

    const compData = [
        { q: "é»ƒè£•ç¿”åªèƒ½ç”¨é‹¼ç´å‰µä½œéŸ³æ¨‚ã€‚", a: false },
        { q: "ç”Ÿæ´»ä¸­çš„è²éŸ³ä¹Ÿèƒ½æˆç‚ºéŸ³æ¨‚ç´ æã€‚", a: true },
        { q: "é»ƒè£•ç¿”é›–ç„¶çœ‹ä¸è¦‹ï¼Œä½†ä»–ç”¨è€³æœµæ„Ÿå—ä¸–ç•Œã€‚", a: true }
    ];

    const rhetoricData = [
        { q: "ã€ŒæŒè²æ‰å¦‚é›·èˆ¬çš„éŸ¿èµ·ã€é‹ç”¨äº†ä»€éº¼ä¿®è¾­ï¼Ÿ", opts: ["è­¬å–»", "æ“¬äºº", "æ’æ¯”"], a: "è­¬å–»" },
        { q: "å¼•ç”¨åè¨€ã€Œä¸Šå¤©ç‚ºæˆ‘å€‘é—œä¸Šä¸€é“é–€...ã€æ˜¯ç‚ºäº†ï¼Ÿ", opts: ["å¢åŠ å­—æ•¸", "æ”¯æŒè§€é»", "ç·´ç¿’å¯«å­—"], a: "æ”¯æŒè§€é»" }
    ];

    const gameData = [
        { 
            type: "select", 
            q: "é—œå¡ 1ï¼šæ‰¾å‡ºèª²æ–‡ä¸­çš„ã€Œè²éŸ³æå¯«ã€", 
            opts: ["ä¸ƒå½©ç¹½ç´›", "è½Ÿéš†éš†", "é»‘æ¼†æ¼†"], 
            a: "è½Ÿéš†éš†",
            hint: "æ‰¾æ‰¾çœ‹å“ªå€‹è©æœ‰è²éŸ³çš„æ„Ÿè¦ºï¼Ÿ"
        },
        { 
            type: "select", 
            q: "é—œå¡ 2ï¼šé»ƒè£•ç¿”åœ¨å¤§è³£å ´å–œæ­¡æ•²æ‰“ä»€éº¼ç•¶æ¨‚å™¨ï¼Ÿ", 
            opts: ["è¥¿ç“œ", "é‹ç¢—ç“¢ç›†", "é›»è¦–æ©Ÿ"], 
            a: "é‹ç¢—ç“¢ç›†",
            hint: "åœ¨å»šå…·å€æœƒçœ‹åˆ°ä»€éº¼ï¼Ÿ"
        },
        { 
            type: "select", 
            q: "é—œå¡ 3ï¼šã€ŒéŸ³æ¨‚ç„¡æ‰€ä¸åœ¨ã€é€™å¥è©±ç”¨äº†ä»€éº¼ä¿®è¾­ä¾†å¼·èª¿ï¼Ÿ", 
            opts: ["è¨­å•", "å¼•ç”¨", "èª‡é£¾"], 
            a: "å¼•ç”¨",
            hint: "é€™æ˜¯å¼•ç”¨èª°èªªéçš„è©±å‘¢ï¼Ÿ"
        }
    ];

    // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---

    function startApp() {
        const name = document.getElementById('studentName').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥åå­—å–”ï¼");
        
        currentUser = name;
        document.getElementById('displayUser').textContent = name;
        document.getElementById('displayUser').className = "bg-indigo-100 px-3 py-1 rounded-full text-sm font-bold text-indigo-600 border border-indigo-200";
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('mainApp').classList.add('pop-in');
        
        // åˆå§‹åŒ–å„å–®å…ƒ
        initVocab();
        initTypo();
        initMatch();
        initComp();
        initRhetoric();
        initGame();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + tabId).classList.remove('hidden');
        document.getElementById('view-' + tabId).classList.add('pop-in');
        
        // æ»¾å‹•åˆ°å…§å®¹å€
        document.getElementById('contentArea').scrollIntoView({behavior: 'smooth'});
    }

    function showFeedback(msg, type) {
        const toast = document.getElementById('feedbackToast');
        const text = document.getElementById('feedbackText');
        const icon = document.getElementById('feedbackIcon');
        
        toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 translate-y-0 opacity-100 ${type === 'success' ? 'bg-green-600' : 'bg-orange-500'} text-white`;
        
        icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-lightbulb"></i>';
        text.innerText = msg;

        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-10');
        }, 2000);
    }

    // --- å„å–®å…ƒå¯¦ä½œ ---

    // 1. åœ‹å­—æ³¨éŸ³
    function initVocab() {
        const container = document.getElementById('vocab-container');
        let currentIdx = 0;
        let correctCount = 0;

        function render() {
            if (currentIdx >= vocabData.length) {
                container.innerHTML = `<div class="text-xl font-bold text-indigo-600">ğŸ‰ å®ŒæˆæŒ‘æˆ°ï¼ç­”å° ${correctCount}/${vocabData.length} é¡Œ</div>
                <button onclick="initVocab()" class="mt-4 bg-gray-200 px-4 py-2 rounded-lg">å†ç©ä¸€æ¬¡</button>`;
                saveRecord('åœ‹å­—æ³¨éŸ³', correctCount, vocabData.length - correctCount);
                return;
            }
            const q = vocabData[currentIdx];
            container.innerHTML = `
                <div class="text-xl mb-6 font-bold bg-blue-50 p-4 rounded-xl inline-block border-2 border-blue-100">${q.q}</div>
                <div class="flex justify-center gap-4">
                    ${q.opts.map(opt => `<button onclick="checkVocab('${opt}', '${q.a}')" class="btn-custom bg-white border-2 border-blue-200 text-2xl w-24 h-24 rounded-2xl hover:bg-blue-50 font-bold text-blue-700">${opt}</button>`).join('')}
                </div>
            `;
        }

        window.checkVocab = (ans, correct) => {
            if (ans === correct) {
                showFeedback("ä½ æŠ“åˆ°è²éŸ³çš„ç§˜å¯†äº†ï¼", "success");
                correctCount++;
            } else {
                showFeedback("å†è½ä¸€æ¬¡ï¼Œç­”æ¡ˆå°±åœ¨è²éŸ³è£¡ï¼", "hint");
            }
            currentIdx++;
            setTimeout(render, 500);
        };
        render();
    }

    // 2. æ”¹éŒ¯å­—
    function initTypo() {
        const container = document.getElementById('typo-container');
        container.innerHTML = '';
        let correctCount = 0;
        let attempts = 0;

        typoData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = "bg-gray-50 p-4 rounded-xl border border-gray-200 text-lg tracking-wider";
            
            // æ§‹å»ºå¥å­ï¼Œæ¯å€‹å­—éƒ½æ˜¯å¯é»æ“Šçš„
            let html = '';
            for(let i=0; i<item.sent.length; i++) {
                html += `<span class="typo-char" onclick="checkTypo(this, ${idx}, ${i})">${item.sent[i]}</span>`;
            }
            div.innerHTML = html;
            div.id = `typo-row-${idx}`;
            container.appendChild(div);
        });

        window.checkTypo = (span, itemIdx, charIdx) => {
            const q = typoData[itemIdx];
            if (charIdx === q.wrongIndex) {
                span.innerText = q.correct;
                span.className = "text-red-600 font-bold border-b-2 border-red-500 pb-1 mx-1 px-2 bg-red-50 rounded";
                span.onclick = null; // ç§»é™¤é»æ“Šäº‹ä»¶
                showFeedback("å¤ªæ£’äº†ï¼å°åµæ¢æ‰¾åˆ°éŒ¯å­—äº†ï¼", "success");
                
                // é¡¯ç¤ºè§£é‡‹
                const explain = document.createElement('div');
                explain.className = "mt-2 text-sm text-gray-500 bg-white p-2 rounded shadow-sm inline-block";
                explain.innerHTML = `<i class="fas fa-info-circle text-blue-400"></i> åŸå­—ã€Œ${q.wrongChar}ã€æ˜¯éŒ¯èª¤çš„ï¼Œæ‡‰æ”¹ç‚ºã€Œ${q.correct}ã€ã€‚`;
                document.getElementById(`typo-row-${itemIdx}`).appendChild(explain);

                correctCount++;
                if(correctCount === typoData.length) saveRecord('éŒ¯å­—åµæ¢', correctCount, attempts);
            } else {
                span.classList.add('wrong-anim');
                setTimeout(() => span.classList.remove('wrong-anim'), 500);
                showFeedback("é€™è£¡æ²’æœ‰éŒ¯å­—å–”ï¼Œå†æ‰¾æ‰¾çœ‹ï¼", "hint");
                attempts++;
            }
        };
    }

    // 3. è©èªé…å° (Click to Match)
    function initMatch() {
        const container = document.getElementById('match-game');
        // æ´—ç‰Œ
        const shuffled = [...matchData].sort(() => Math.random() - 0.5);
        container.innerHTML = '';
        let selected = null;
        let matches = 0;
        let errors = 0;

        shuffled.forEach(item => {
            const btn = document.createElement('button');
            btn.className = "btn-custom bg-white border border-purple-200 text-gray-700 p-4 rounded-xl font-bold text-lg hover:bg-purple-50";
            btn.innerText = item.text;
            btn.dataset.id = item.id;
            btn.dataset.pair = item.pair;
            
            btn.onclick = () => {
                if (selected === btn) { // å–æ¶ˆé¸å–
                    btn.classList.remove('match-selected');
                    selected = null;
                    return;
                }

                if (!selected) {
                    selected = btn;
                    btn.classList.add('match-selected');
                } else {
                    // æª¢æŸ¥é…å°
                    if (selected.dataset.pair == btn.dataset.id) {
                        // é…å°æˆåŠŸ
                        selected.classList.add('correct-anim', 'bg-green-200', 'border-green-500');
                        btn.classList.add('correct-anim', 'bg-green-200', 'border-green-500');
                        showFeedback("é…å°æˆåŠŸï¼", "success");
                        
                        const s = selected;
                        const b = btn;
                        setTimeout(() => {
                            s.classList.add('match-solved');
                            b.classList.add('match-solved');
                        }, 500);
                        
                        matches++;
                        selected = null;
                        if(matches === matchData.length / 2) {
                            saveRecord('è©èªé…å°', matches, errors);
                            setTimeout(() => {
                                container.innerHTML = `<div class="col-span-4 text-center text-xl font-bold text-purple-600 p-4">ğŸ‰ å…¨éƒ¨é…å°å®Œæˆï¼</div>`;
                            }, 1000);
                        }
                    } else {
                        // é…å°å¤±æ•—
                        btn.classList.add('wrong-anim');
                        selected.classList.add('wrong-anim');
                        showFeedback("é€™å…©å€‹ä¸æ˜¯ä¸€å°å–”ï¼", "hint");
                        errors++;
                        setTimeout(() => {
                            btn.classList.remove('wrong-anim');
                            selected.classList.remove('wrong-anim', 'match-selected');
                            selected = null;
                        }, 500);
                    }
                }
            };
            container.appendChild(btn);
        });
    }

    // 4. ç†è§£ & 5. ä¿®è¾­ (Generic Render)
    function renderQuiz(containerId, data, title, typeName) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        let correct = 0;
        let done = 0;

        data.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = "mb-4 bg-gray-50 p-4 rounded-xl text-left border border-gray-200";
            let optsHtml = '';
            
            if (q.a === true || q.a === false) { // True/False
                optsHtml = `
                    <button class="btn-custom bg-green-100 text-green-700 w-12 h-12 rounded-full mr-2 hover:bg-green-200" onclick="checkGen(this, ${q.a}, true, ${idx})">â—‹</button>
                    <button class="btn-custom bg-red-100 text-red-700 w-12 h-12 rounded-full hover:bg-red-200" onclick="checkGen(this, ${q.a}, false, ${idx})">âœ•</button>
                `;
            } else { // Multiple Choice
                optsHtml = q.opts.map(opt => 
                    `<button class="btn-custom bg-white border border-gray-300 px-3 py-1 rounded-lg m-1 hover:bg-gray-100" onclick="checkGen(this, '${q.a}', '${opt}', ${idx})">${opt}</button>`
                ).join('');
            }

            div.innerHTML = `<p class="font-bold mb-2">${idx+1}. ${q.q}</p><div id="ans-area-${containerId}-${idx}">${optsHtml}</div>`;
            container.appendChild(div);
        });

        // Closure to keep scope
        window[`done_${containerId}`] = 0;
        window[`correct_${containerId}`] = 0;
        
        // Dynamic check function
        window.checkGen = (btn, correctVal, userVal, idx) => {
            const area = btn.parentElement;
            // Disable all buttons in this question
            const btns = area.getElementsByTagName('button');
            for(let b of btns) b.disabled = true;

            if (userVal === correctVal) {
                btn.className = "bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow-md";
                btn.innerHTML += ' âœ”ï¸';
                showFeedback("ç­”å°äº†ï¼", "success");
                window[`correct_${containerId}`]++;
            } else {
                btn.className = "bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow-md";
                showFeedback("å¯æƒœç­”éŒ¯äº†", "hint");
            }
            window[`done_${containerId}`]++;
            
            if (window[`done_${containerId}`] === data.length) {
                saveRecord(typeName, window[`correct_${containerId}`], data.length - window[`correct_${containerId}`]);
            }
        };
    }

    function initComp() { renderQuiz('comp-container', compData, 'èª²æ–‡ç†è§£', 'èª²æ–‡ç†è§£'); }
    function initRhetoric() { renderQuiz('rhetoric-container', rhetoricData, 'ä¿®è¾­', 'ä¿®è¾­äº’å‹•'); }

    // 6. éŠæˆ²
    function initGame() {
        const stage = document.getElementById('game-stage');
        let level = 0;
        let score = 0;

        function renderLevel() {
            if (level >= gameData.length) {
                stage.innerHTML = `
                    <div class="text-6xl mb-4">ğŸ†</div>
                    <h3 class="text-2xl font-bold text-indigo-700 mb-2">ä»»å‹™å®Œæˆï¼</h3>
                    <p class="text-gray-500">ä½ å·²ç¶“æˆç‚ºè²éŸ³é­”æ³•å¸«äº†ï¼</p>
                    <div class="mt-4 font-bold text-xl">æœ€çµ‚å¾—åˆ†: ${score}</div>
                `;
                saveRecord('é—–é—œéŠæˆ²', score/10, gameData.length - (score/10));
                return;
            }

            const q = gameData[level];
            document.getElementById('game-level').innerText = level + 1;
            
            stage.innerHTML = `
                <div class="bg-indigo-50 p-6 rounded-2xl w-full max-w-md pop-in">
                    <p class="text-lg font-bold mb-6">${q.q}</p>
                    <div class="grid gap-3">
                        ${q.opts.map(opt => `
                            <button onclick="checkGameAns('${opt}', '${q.a}')" class="btn-custom w-full bg-white border-2 border-indigo-100 py-3 rounded-xl font-bold text-indigo-600 hover:bg-indigo-500 hover:text-white transition">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.checkGameAns = (ans, correct) => {
            if (ans === correct) {
                score += 10;
                document.getElementById('game-score').innerText = score;
                showFeedback("ç­”å°äº†ï¼æ™‰ç´šä¸‹ä¸€é—œï¼", "success");
                level++;
                setTimeout(renderLevel, 800);
            } else {
                showFeedback(gameData[level].hint, "hint");
            }
        };
        renderLevel();
    }

    // --- å»¶ä¼¸ä»»å‹™ ---
    function submitExtension() {
        const val = document.getElementById('extend-answer').value;
        if(val) {
            saveRecord('å»¶ä¼¸ä»»å‹™', 1, 0); // åªè¦æäº¤å°±ç®—å®Œæˆ
            alert("æƒ³æ³•å·²æäº¤ï¼è¬è¬ä½ çš„åˆ†äº« â¤ï¸");
            document.getElementById('extend-answer').value = '';
        }
    }

    // --- è³‡æ–™å„²å­˜èˆ‡è¨˜éŒ„ ---
    
    function saveRecord(moduleName, correct, wrong) {
        const record = {
            time: new Date().toLocaleString(),
            name: currentUser,
            module: moduleName,
            correct: correct,
            wrong: wrong,
            score: Math.round((correct / (correct + wrong)) * 100) || 100
        };

        // 1. å­˜å…¥ LocalStorage (å­¸ç”Ÿç«¯è¨˜éŒ„)
        let history = JSON.parse(localStorage.getItem('musicFlyHistory') || '[]');
        history.unshift(record);
        localStorage.setItem('musicFlyHistory', JSON.stringify(history));

        // 2. å‚³é€è‡³ Google Sheet
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // é‡è¦ï¼šé¿å… CORS éŒ¯èª¤
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record)
        }).then(() => {
            console.log("Sent to Google Sheet");
        }).catch(err => console.error(err));
    }

    function showHistory() {
        if (!currentUser) return alert("è«‹å…ˆç™»å…¥å–”ï¼");
        
        const history = JSON.parse(localStorage.getItem('musicFlyHistory') || '[]');
        const list = document.getElementById('historyList');
        const modal = document.getElementById('historyModal');
        
        list.innerHTML = '';
        if (history.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-500">ç›®å‰é‚„æ²’æœ‰è¨˜éŒ„ï¼Œå¿«å»æŒ‘æˆ°å§ï¼</p>';
        } else {
            // éæ¿¾ç•¶å‰ä½¿ç”¨è€…çš„è¨˜éŒ„
            const myHistory = history.filter(r => r.name === currentUser);
            myHistory.forEach(r => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 rounded-lg border-l-4 border-indigo-400 flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-700">${r.module}</div>
                        <div class="text-xs text-gray-400">${r.time}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg ${r.score >= 80 ? 'text-green-600' : 'text-orange-500'}">${r.score}åˆ†</div>
                        <div class="text-xs text-gray-500">å°${r.correct}/éŒ¯${r.wrong}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        modal.classList.remove('hidden');
    }

</script>
</body>
</html>
